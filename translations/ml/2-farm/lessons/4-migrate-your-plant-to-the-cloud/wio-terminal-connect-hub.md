# เดจเดฟเดเตเดเดณเตเดเต IoT เดเดชเดเดฐเดฃเด เดเตเดฒเตเดกเตเดฎเดพเดฏเดฟ เดฌเดจเตเดงเดฟเดชเตเดชเดฟเดเตเดเตเด - Wio Terminal

เด เดชเดพเดเดญเดพเดเดคเตเดคเดฟเตฝ, เดจเดฟเดเตเดเดณเตเดเต Wio Terminal เดจเดฟเดเตเดเดณเตเดเต IoT Hub-เดฒเตเดเต เดเดฃเดเตเดฑเตเดฑเต เดเตเดฏเตเดคเต เดเตเดฒเดฟเดฎเตเดเตเดฐเดฟ เดเดฏเดฏเตเดเตเดเตเดเดฏเตเด เดเดฎเดพเตปเดกเตเดเตพ เดธเตเดตเตเดเดฐเดฟเดเตเดเตเดเดฏเตเด เดเตเดฏเตเดฏเตเด.

## เดจเดฟเดเตเดเดณเตเดเต เดเดชเดเดฐเดฃเด IoT Hub-เดฒเตเดเตเดเต เดเดฃเดเตเดฑเตเดฑเต เดเตเดฏเตเดฏเตเด

เดเดเตเดคเตเดค เดเดเตเดเด เดจเดฟเดเตเดเดณเตเดเต เดเดชเดเดฐเดฃเด IoT Hub-เดฒเตเดเตเดเต เดฌเดจเตเดงเดฟเดชเตเดชเดฟเดเตเดเตเดเดฏเดพเดฃเต.

### เดเดพเดธเตโเดเต - IoT Hub-เดฒเตเดเตเดเต เดเดฃเดเตเดฑเตเดฑเต เดเตเดฏเตเดฏเตเด

1. VS Code-เตฝ `soil-moisture-sensor` เดชเตเดฐเตเดเดเตเดฑเตเดฑเต เดคเตเดฑเดเตเดเต

1. `platformio.ini` เดซเดฏเตฝ เดคเตเดฑเดเตเดเตเด. `knolleary/PubSubClient` เดฒเตเดฌเตเดฐเดฑเดฟ เดกเดฟเดชเตเดชเตเตปเดกเตปเดธเดฟ เดจเตเดเตเดเด เดเตเดฏเตเดฏเตเด. เดเดคเต เดชเดฌเตเดฒเดฟเดเตเดเต MQTT เดฌเตเดฐเตเดเตเดเดฑเตเดฎเดพเดฏเดฟ เดเดฃเดเตเดฑเตเดฑเต เดเตเดฏเตเดฏเดพเดจเดพเดฏเดฟ เดเดชเดฏเตเดเดฟเดเตเดเดคเต, IoT Hub-เดฒเตเดเตเดเต เดเดฃเดเตเดฑเตเดฑเต เดเตเดฏเตเดฏเดพเตป เดเดตเดถเตเดฏเดฎเดฟเดฒเตเดฒ.

1. เดคเดพเดดเตเดเตเดเตเดเตเดคเตเดค เดฒเตเดฌเตเดฐเดฑเดฟ เดกเดฟเดชเตเดชเตเตปเดกเตปเดธเดฟเดเตพ เดเตเตผเดเตเดเตเด:

    ```ini
    seeed-studio/Seeed Arduino RTC @ 2.0.0
    arduino-libraries/AzureIoTHub @ 1.6.0
    azure/AzureIoTUtility @ 1.6.1
    azure/AzureIoTProtocol_MQTT @ 1.6.0
    azure/AzureIoTProtocol_HTTP @ 1.6.0
    azure/AzureIoTSocket_WiFi @ 1.0.2
    ```

    `Seeed Arduino RTC` เดฒเตเดฌเตเดฐเดฑเดฟ Wio Terminal-เตฝ เดฑเดฟเดฏเตฝ-เดเตเด เดเตเดฒเตเดเตเดเตเดฎเดพเดฏเดฟ เดเดเดชเดดเดเดพเตป เดเตเดกเต เดจเตฝเดเตเดจเตเดจเต, เดธเดฎเดฏเดฎเดจเตเดธเดฐเดฟเดเตเดเต เดเตเดฐเดพเดเตเดเต เดเตเดฏเตเดฏเดพเตป. เดถเตเดทเดฟเดเตเดเตเดจเตเดจ เดฒเตเดฌเตเดฐเดฑเดฟเดเตพ เดจเดฟเดเตเดเดณเตเดเต IoT เดเดชเดเดฐเดฃเด IoT Hub-เดฒเตเดเตเดเต เดเดฃเดเตเดฑเตเดฑเต เดเตเดฏเตเดฏเดพเตป เดธเดนเดพเดฏเดฟเดเตเดเตเด.

1. `platformio.ini` เดซเดฏเดฒเดฟเดจเตเดฑเต เดเดเดฟเดฏเดฟเตฝ เดคเดพเดดเตเดเตเดเตเดเตเดคเตเดคเดคเต เดเตเตผเดเตเดเตเด:

    ```ini
    build_flags =
        -DDONT_USE_UPLOADTOBLOB
    ```

    เดเดคเต Arduino IoT Hub เดเตเดกเต เดเดฎเตเดชเตเตฝ เดเตเดฏเตเดฏเตเดฎเตเดชเตเตพ เดเดตเดถเตเดฏเดฎเดพเดฏ เดเตเดฎเตเดชเตเดฒเตผ เดซเตเดฒเดพเดเต เดธเตเดฑเตเดฑเต เดเตเดฏเตเดฏเตเดจเตเดจเต.

1. `config.h` เดนเตเดกเตผ เดซเดฏเตฝ เดคเตเดฑเดเตเดเตเด. เดฎเตเดดเตเดตเตป MQTT เดธเดเตเดเตเดเดฐเดฃเดเตเดเดณเตเด เดจเตเดเตเดเด เดเตเดฏเตเดคเต เดเตเดตเดเต เดเตเดเตเดคเตเดคเดฟเดฐเดฟเดเตเดเตเดจเตเดจ เดกเดฟเดตเตเดธเต เดเดฃเดเตเดทเตป เดธเตเดเตเดฐเดฟเดเดเต เดเตเตบเดธเตเดฑเตเดฑเดจเตเดฑเต เดเตเตผเดเตเดเตเด:

    ```cpp
    // เดเดเดเดฟ เดนเดฌเต เดเตเดฐเดฎเตเดเดฐเดฃเดเตเดเตพ
    const char *CONNECTION_STRING = "<connection string>";
    ```

    `<connection string>`-เดจเตเดฑเต เดเดเดคเตเดคเต เดฎเตเตปเดชเต เดเตเดชเตเดชเดฟ เดเตเดฏเตเดค เดจเดฟเดเตเดเดณเตเดเต เดเดชเดเดฐเดฃเดคเตเดคเดฟเดจเตเดฑเต เดเดฃเดเตเดทเตป เดธเตเดเตเดฐเดฟเดเตเดเต เดตเดเตเดเดฟเดเตเด.

1. IoT Hub-เดฒเตเดเตเดเต เดเดฃเดเตเดทเตป เดธเดฎเดฏเด เดเดเดฟเดธเตเดฅเดพเดจเดฎเดพเดฏ เดเตเดเตเดเตบ เดเดชเดฏเตเดเดฟเดเตเดเตเดจเตเดจเต. เดเดคเดพเดฏเดคเต, IoT เดเดชเดเดฐเดฃเด เดจเดฟเดฒเดตเดฟเดฒเต เดธเดฎเดฏเด เดเดฑเดฟเดฏเดฃเด. Windows, macOS, Linux เดชเตเดฒเตเดณเตเดณ เดเดชเตเดชเดฑเตเดฑเตเดฑเดฟเดเดเต เดธเดฟเดธเตเดฑเตเดฑเดเตเดเดณเตเดชเตเดฒเต, เดฎเตเดเตเดฐเตเดเตบเดเตเดฐเตเดณเดฑเตเดเตพ เดเดจเตเดฑเตผเดจเตเดฑเตเดฑเดฟเดฒเตเดเต เดธเตเดตเดฏเด เดธเดฎเดฏเด เดธเดฟเดเตเดเต เดเตเดฏเตเดฏเตเดจเตเดจเดคเดฒเตเดฒ. เดเดคเดฟเดจเดพเตฝ [NTP](https://wikipedia.org/wiki/Network_Time_Protocol) เดธเตผเดตเดฑเดฟเตฝ เดจเดฟเดจเตเดจเตเดณเตเดณ เดจเดฟเดฒเดตเดฟเดฒเต เดธเดฎเดฏเด เดจเตเดเดพเตป เดเตเดกเต เดเตเตผเดเตเดเตเดฃเตเดเดคเดพเดฃเต. เดธเดฎเดฏเด เดเดฟเดเตเดเดฟเดฏ เดถเตเดทเด, เดเดคเต Wio Terminal-เดฒเต เดฑเดฟเดฏเตฝ-เดเตเด เดเตเดฒเตเดเตเดเดฟเตฝ เดธเดเดญเดฐเดฟเดเตเดเดพเด, เดเดชเดเดฐเดฃเด เดชเดตเตผ เดจเดทเตเดเดฎเดพเดเตเดเดพเดคเต เดเตเดคเตเดฏเดฎเดพเดฏ เดธเดฎเดฏเดฎเดฑเดฟเดฏเดพเด. `ntp.h` เดเดจเตเดจ เดชเตเดคเดฟเดฏ เดซเดฏเตฝ เดคเดพเดดเตเดเตเดเตเดเตเดคเตเดค เดเตเดกเตเดเตเดเตเดเดฟ เดเตเตผเดเตเดเตเด:

    ```cpp
    #pragma once
    
    #include "DateTime.h"
    #include <time.h>
    #include "samd/NTPClientAz.h"
    #include <sys/time.h>

    static void initTime()
    {
        WiFiUDP _udp;
        time_t epochTime = (time_t)-1;
        NTPClientAz ntpClient;

        ntpClient.begin();

        while (true)
        {
            epochTime = ntpClient.getEpochTime("0.pool.ntp.org");

            if (epochTime == (time_t)-1)
            {
                Serial.println("Fetching NTP epoch time failed! Waiting 2 seconds to retry.");
                delay(2000);
            }
            else
            {
                Serial.print("Fetched NTP epoch time is: ");

                char buff[32];
                sprintf(buff, "%.f", difftime(epochTime, (time_t)0));
                Serial.println(buff);
                break;
            }
        }

        ntpClient.end();

        struct timeval tv;
        tv.tv_sec = epochTime;
        tv.tv_usec = 0;

        settimeofday(&tv, NULL);
    }
    ```

    เด เดเตเดกเดฟเดจเตเดฑเต เดตเดฟเดถเดฆเดพเดเดถเดเตเดเตพ เด เดชเดพเดเดญเดพเดเดคเตเดคเดฟเดจเตเดฑเต เดชเดฐเดฟเดงเดฟเดฏเตเดเตเดเต เดชเตเดฑเดคเตเดคเดพเดฃเต. `initTime` เดเดจเตเดจ เดซเดเดเตเดทเตป เดจเดฟเตผเดตเตเดตเดเดฟเดเตเดเตเดจเตเดจเต, NTP เดธเตผเดตเดฑเดฟเตฝ เดจเดฟเดจเตเดจเตเดณเตเดณ เดธเดฎเดฏเด เดตเดพเดเตเดเดฟ Wio Terminal-เดฒเต เดเตเดฒเตเดเตเดเต เดธเตเดฑเตเดฑเต เดเตเดฏเตเดฏเดพเตป เดเดชเดฏเตเดเดฟเดเตเดเตเดจเตเดจเต.

1. `main.cpp` เดซเดฏเตฝ เดคเตเดฑเดจเตเดจเต เดฎเตเดดเตเดตเตป MQTT เดเตเดกเต เดจเตเดเตเดเด เดเตเดฏเตเดฏเตเด, `PubSubClient.h` เดนเตเดกเตผ เดซเดฏเตฝ, `PubSubClient` เดตเตเดฐเดฟเดฏเตเดฌเดฟเตพ เดชเตเดฐเดเตเดฏเดพเดชเดจเดตเตเด, `reconnectMQTTClient` เฎฎเฎฑเฏเฎฑเฏเฎฎเฏ `createMQTTClient` เดฐเตเดคเดฟเดเตพ, เดถเตเดชเดพเตผเดถเดเดณเตเด เดจเตเดเตเดเด เดเตเดฏเตเดฏเตเด. เด เดซเดฏเตฝ WiFi เดเดฃเดเตเดฑเตเดฑเต เดเตเดฏเตเดฏเตเดจเตเดจเดคเดฟเดจเตเดณเตเดณ, เดฎเดฃเตเดฃเต เดคเตเดฐเตเดฏเดค เดเตเดฎเดพเดฑเตเดจเตเดจเดคเดฟเดจเตเดณเตเดณ, JSON เดกเตเดเตเดฏเตเดฎเตเดจเตเดฑเต เดธเตเดทเตเดเดฟเดเตเดเตเดจเตเดจเดคเดฟเดจเตเดณเตเดณ เดเตเดกเต เดฎเดพเดคเตเดฐเดฎเต เดเดณเตเดณเต.

1. `main.cpp` เดซเดฏเดฒเดฟเดจเตเดฑเต เดฎเตเดเดณเดฟเตฝ เดคเดพเดดเตเดเตเดเตเดเตเดคเตเดค `#include` เดจเดฟเตผเดฆเตเดฆเตเดถเดเตเดเตพ เดเตเตผเดเตเดเตเด, IoT Hub เดฒเตเดฌเตเดฐเดฑเดฟเดเตพเดเตเดเตเด เดธเดฎเดฏ เดธเตเดฑเตเดฑเดฟเดเดเดฟเดจเตเด:

    ```cpp
    #include <AzureIoTHub.h>
    #include <AzureIoTProtocol_MQTT.h>
    #include <iothubtransportmqtt.h>
    #include "ntp.h"
    ```

1. `setup` เดซเดเดเตเดทเดจเตเดฑเต เดเดตเดธเดพเดจเด เดจเดฟเดฒเดตเดฟเดฒเต เดธเดฎเดฏเด เดธเตเดฑเตเดฑเต เดเตเดฏเตเดฏเดพเตป เดคเดพเดดเตเดเตเดเตเดเตเดคเตเดค เดเตเตพ เดเตเตผเดเตเดเตเด:

    ```cpp
    initTime();
    ```

1. เดซเดฏเดฒเดฟเดจเตเดฑเต เดฎเตเดเดณเดฟเตฝ, `#include` เดจเดฟเตผเดฆเตเดฆเตเดถเดเตเดเดณเตเดเต เดคเดพเดดเต, เดคเดพเดดเตเดเตเดเตเดเตเดคเตเดค เดตเตเดฐเดฟเดฏเตเดฌเดฟเตพ เดชเตเดฐเดเตเดฏเดพเดชเดจเด เดเตเตผเดเตเดเตเด:

    ```cpp
    IOTHUB_DEVICE_CLIENT_LL_HANDLE _device_ll_handle;
    ```

    เดเดคเต เดเดฐเต `IOTHUB_DEVICE_CLIENT_LL_HANDLE` เดชเตเดฐเดเตเดฏเดพเดชเดฟเดเตเดเตเดจเตเดจเต, IoT Hub-เดฒเตเดเตเดเต เดเดฃเดเตเดทเตป เดเตเดเดพเดฐเตเดฏเด เดเตเดฏเตเดฏเดพเดจเตเดณเตเดณ เดนเดพเตปเดกเดฟเตฝ.

1. เดเดคเดฟเดจเต เดคเดพเดดเต, เดคเดพเดดเตเดเตเดเตเดเตเดคเตเดค เดเตเดกเต เดเตเตผเดเตเดเตเด:

    ```cpp
    static void connectionStatusCallback(IOTHUB_CLIENT_CONNECTION_STATUS result, IOTHUB_CLIENT_CONNECTION_STATUS_REASON reason, void *user_context)
    {
        if (result == IOTHUB_CLIENT_CONNECTION_AUTHENTICATED)
        {
            Serial.println("The device client is connected to iothub");
        }
        else
        {
            Serial.println("The device client has been disconnected");
        }
    }
    ```

    เดเดคเต เดเดฐเต เดเตเตพเดฌเดพเดเตเดเต เดซเดเดเตเดทเตป เดชเตเดฐเดเตเดฏเดพเดชเดฟเดเตเดเตเดจเตเดจเต, IoT Hub-เดฒเตเดเตเดเต เดเดฃเดเตเดทเตป เดจเดฟเดฒ เดฎเดพเดฑเตเดฎเตเดชเตเตพ (เดเดฃเดเตเดฑเตเดฑเต เดเตเดฏเตเดฏเตเด เดเดฒเตเดฒเตเดเตเดเดฟเตฝ เดกเดฟเดธเตโเดเดฃเดเตเดฑเตเดฑเต เดเตเดฏเตเดฏเตเด) เดตเดฟเดณเดฟเดเตเดเดชเตเดชเตเดเตเด. เดจเดฟเดฒ เดธเตเดฐเดฟเดฏเตฝ เดชเตเตผเดเตเดเดฟเดฒเตเดเตเดเต เดเดฏเดฏเตเดเตเดเตเดจเตเดจเต.

1. เดเดคเดฟเดจเต เดคเดพเดดเต, IoT Hub-เดฒเตเดเตเดเต เดเดฃเดเตเดฑเตเดฑเต เดเตเดฏเตเดฏเดพเดจเตเดณเตเดณ เดซเดเดเตเดทเตป เดเตเตผเดเตเดเตเด:

    ```cpp
    void connectIoTHub()
    {
        IoTHub_Init();
    
        _device_ll_handle = IoTHubDeviceClient_LL_CreateFromConnectionString(CONNECTION_STRING, MQTT_Protocol);
        
        if (_device_ll_handle == NULL)
        {
            Serial.println("Failure creating Iothub device. Hint: Check your connection string.");
            return;
        }
    
        IoTHubDeviceClient_LL_SetConnectionStatusCallback(_device_ll_handle, connectionStatusCallback, NULL);
    }
    ```

    เด เดเตเดกเต IoT Hub เดฒเตเดฌเตเดฐเดฑเดฟ เดเตปเดทเตเดฏเดฒเตเดธเต เดเตเดฏเตเดฏเตเดจเตเดจเต, เดถเตเดทเด `config.h` เดซเดฏเดฒเดฟเดฒเตเดณเตเดณ เดเดฃเดเตเดทเตป เดธเตเดเตเดฐเดฟเดเตเดเต เดเดชเดฏเตเดเดฟเดเตเดเต MQTT เดเดเดฟเดธเตเดฅเดพเดจเดคเตเดคเดฟเดฒเตเดณเตเดณ เดเดฃเดเตเดทเตป เดธเตเดทเตเดเดฟเดเตเดเตเดจเตเดจเต. เดเดฃเดเตเดทเตป เดชเดฐเดพเดเดฏเดชเตเดชเตเดเตเดจเตเดจเตเดตเตเดเตเดเดฟเตฝ, เดธเตเดฐเดฟเดฏเตฝ เดชเตเตผเดเตเดเดฟเดฒเตเดเตเดเต เดชเดฟเดดเดตเต เดเดฏเดฏเตเดเตเดเตเดจเตเดจเต - เดเดคเต เดตเดจเตเดจเดพเตฝ เดเดฃเดเตเดทเตป เดธเตเดเตเดฐเดฟเดเตเดเต เดชเดฐเดฟเดถเตเดงเดฟเดเตเดเตเด. เดเดตเดธเดพเดจเด เดเดฃเดเตเดทเตป เดจเดฟเดฒ เดเตเตพเดฌเดพเดเตเดเต เดธเตเดฑเตเดฑเต เดเตเดฏเตเดฏเตเดจเตเดจเต.

1. เด เดซเดเดเตเดทเตป `setup` เดซเดเดเตเดทเดจเดฟเตฝ `initTime` เดเตเตพเดเตเดเต เดคเดพเดดเต เดตเดฟเดณเดฟเดเตเดเตเด:

    ```cpp
    connectIoTHub();
    ```

1. MQTT เดเตเดฒเดฏเดจเตเดฑเต เดชเตเดฒเตเดฏเดพเดฃเต เดเตเดกเตเด single thread- เตฝ เดชเตเดฐเดตเตผเดคเตเดคเดฟเดเตเดเตเดจเตเดจเดคเต เดเดจเตเดจเดคเดฟเดจเดพเตฝ เดนเดฌเต เดตเดดเดฟ เดเดฏเดเตเดเตเดจเตเดจ เดธเดจเตเดฆเตเดถเดเตเดเตพ เดชเตเดฐเตเดธเดธเต เดเตเดฏเตเดฏเดพเตป เดธเดฎเดฏเดฎเตเดเตเดเตเดเตเด. เดเดคเดฟเดจเดพเตฝ `loop` เดซเดเดเตเดทเดจเตเดฑเต เดฎเตเดเดณเดฟเตฝ เดคเดพเดดเตเดเตเดเตเดเตเดคเตเดคเดคเต เดเตเตผเดเตเดเตเด:

    ```cpp
    IoTHubDeviceClient_LL_DoWork(_device_ll_handle);
    ```

1. เด เดเตเดกเต เดเดฎเตเดชเตเตฝ เดเตเดฏเตเดคเต เดเดชเตโเดฒเตเดกเต เดเตเดฏเตเดฏเตเด. เดธเตเดฐเดฟเดฏเตฝ เดฎเตเดฃเดฟเดฑเตเดฑเดฑเดฟเตฝ เดเดฃเดเตเดทเตป เดเดพเดฃเดพเด:

    ```output
    Connecting to WiFi..
    Connected!
    Fetched NTP epoch time is: 1619983687
    Sending telemetry {"soil_moisture":391}
    The device client is connected to iothub
    ```

    เดเดเตเดเตเดชเตเดเตเดเดฟเตฝ NTP เดธเดฎเดฏเด เดฒเดญเดฟเดเตเดเตเดจเตเดจเดคเต, เดคเตเดเตผเดจเตเดจเต เดเดชเดเดฐเดฃเด เดเดฃเดเตเดฑเตเดฑเต เดเดเตเดจเตเดจเดคเต เดเดพเดฃเดพเด. เดเดฃเดเตเดทเตป เดชเดคเตเดเตเดเต เดเดฏเดคเดฟเดจเดพเตฝ, เดเดฃเดเตเดฑเตเดฑเต เดเตเดฏเตเดฏเตเดฎเตเดชเตเตพ เดฎเดฃเตเดฃเต เดคเตเดฐเตเดฏเดค เดเดเตเดเตเดชเตเดเตเดเดฟเตฝ เดเดพเดฃเดพเดฎเดพเดเดพเด.

    > ๐ UNIX เดธเดฎเดฏเดคเตเดคเต เดตเดพเดฏเดจเดพเดธเดนเดเดฎเดพเดฏ เดฐเตเดชเดคเตเดคเดฟเดฒเตเดเตเดเต เดฎเดพเดฑเตเดฑเดพเตป [unixtimestamp.com](https://www.unixtimestamp.com) เดชเตเดฒเตเดณเตเดณ เดตเตเดฌเตโเดธเตเดฑเตเดฑเต เดเดชเดฏเตเดเดฟเดเตเดเดพเด.

## เดเตเดฒเดฟเดฎเตเดเตเดฐเดฟ เดเดฏเดฏเตเดเตเดเตเด

เดเดชเตเดชเตเตพ เดจเดฟเดเตเดเดณเตเดเต เดเดชเดเดฐเดฃเด เดเดฃเดเตเดฑเตเดฑเต เดเตเดฏเตเดคเดคเดฟเดจเดพเตฝ, MQTT เดฌเตเดฐเตเดเตเดเดฑเดฟเดจเต เดชเดเดฐเด IoT Hub-เดฒเตเดเตเดเต เดเตเดฒเดฟเดฎเตเดเตเดฐเดฟ เดเดฏเดฏเตเดเตเดเดพเตป เดเดดเดฟเดฏเตเด.

### เดเดพเดธเตโเดเต - เดเตเดฒเดฟเดฎเตเดเตเดฐเดฟ เดเดฏเดฏเตเดเตเดเตเด

1. `setup` เดซเดเดเตเดทเดจเต เดฎเตเดเดณเดฟเตฝ เดคเดพเดดเตเดเตเดเตเดเตเดคเตเดค เดซเดเดเตเดทเตป เดเตเตผเดเตเดเตเด:

    ```cpp
    void sendTelemetry(const char *telemetry)
    {
        IOTHUB_MESSAGE_HANDLE message_handle = IoTHubMessage_CreateFromString(telemetry);
        IoTHubDeviceClient_LL_SendEventAsync(_device_ll_handle, message_handle, NULL, NULL);
        IoTHubMessage_Destroy(message_handle);
    }
    ```

    เด เดเตเดกเต เดธเตโเดเตเดฐเดฟเดเตเดเต เดชเดพเดฐเดพเดฎเตเดฑเตเดฑเดฑเดพเดฏเดฟ เดฒเดญเดฟเดเตเด เดฎเดพเดธเตเดเดฟเตฝ เดจเดฟเดจเตเดจเต IoT Hub เดธเดจเตเดฆเตเดถเด เดธเตเดทเตเดเดฟเดเตเดเตเดจเตเดจเต, เดนเดฌเต-เดฒเตเดเตเดเต เดเดฏเดฏเตเดเตเดเตเดจเตเดจเต, เดคเตเดเตผเดจเตเดจเต เดฎเตเดธเตเดเต เดเดฌเตเดเดเตเดเต เดเตเดฒเตเตป เดเตเดฏเตเดฏเตเดจเตเดจเต.

1. `loop` เดซเดเดเตเดทเดจเดฟเตฝ เดเตเดฒเดฟเดฎเตเดเตเดฐเดฟ เดธเตเดฐเดฟเดฏเตฝ เดชเตเตผเดเตเดเดฟเตฝ เดเดฏเดฏเตเดเตเดเตเดจเตเดจ เดตเดฐเดฟเดฏเตเดเตเดเต เดเดเตเดคเตเดคเต เดคเดพเดดเตเดเตเดเตเดเตเดคเตเดค เดเตเตพ เดเตเตผเดเตเดเตเด:

    ```cpp
    sendTelemetry(telemetry.c_str());
    ```

## เดเดฎเดพเตปเดกเตเดเตพ เดเตเดเดพเดฐเตเดฏเด เดเตเดฏเตเดฏเตเด

เดธเตเตผเดตเตผ เดเตเดกเดฟเตฝ เดจเดฟเดจเตเดจเตเดณเตเดณ เดฑเตเดฒเต เดเตบเดเตเดฐเตเตพ เดเตเดฏเตเดฏเดพเดจเตเดณเตเดณ เดเดฎเดพเตปเดกเตเดเตพ เดเตเดเดพเดฐเตเดฏเด เดเตเดฏเตเดฏเตเดฃเตเดเดคเตเดฃเตเดเต. เดเดคเต เดกเดฏเดฐเดเตเดฑเตเดฑเต เดฎเตเดคเตเดคเดกเต เดฑเดฟเดเตเดตเดธเตเดฑเตเดฑเต เดเดจเตเดจ เดฐเตเดชเดคเตเดคเดฟเตฝ เดเดฏเดฏเตเดเตเดเตเดจเตเดจเต.

## เดเดพเดธเตโเดเต - เดกเดฏเดฐเดเตเดฑเตเดฑเต เดฎเตเดคเตเดคเดกเต เดฑเดฟเดเตเดตเดธเตเดฑเตเดฑเต เดนเดพเตปเดกเดฟเตฝ เดเตเดฏเตเดฏเตเด

1. `connectIoTHub` เดซเดเดเตเดทเดจเดฟเดฒเตเดเตเดเต เดฎเตเดฎเตเดชเต เดคเดพเดดเตเดเตเดเตเดเตเดคเตเดค เดเตเดกเต เดเตเตผเดเตเดเตเด:

    ```cpp
    int directMethodCallback(const char *method_name, const unsigned char *payload, size_t size, unsigned char **response, size_t *response_size, void *userContextCallback)
    {
        Serial.printf("Direct method received %s\r\n", method_name);
    
        if (strcmp(method_name, "relay_on") == 0)
        {
            digitalWrite(PIN_WIRE_SCL, HIGH);
        }
        else if (strcmp(method_name, "relay_off") == 0)
        {
            digitalWrite(PIN_WIRE_SCL, LOW);
        }
    }
    ```

    IoT Hub เดฒเตเดฌเตเดฐเดฑเดฟ เดกเดฏเดฐเดเตเดฑเตเดฑเต เดฎเตเดคเตเดคเดกเต เดฑเดฟเดเตเดตเดธเตเดฑเตเดฑเต เดฒเดญเดฟเดเตเดเตเดฎเตเดฌเตเดณเตโ เดตเดฟเดณเดฟเดเตเดเตเดเตเดเดพเดตเตเดจเตเดจ เดเตเตพเดฌเดพเดเตเดเต เดฐเตเดคเดฟเดฏเดพเดฃเต เดเดคเต. เดเดญเตเดฏเตผเดคเตเดฅเดฟเดเตเด เดฎเตเดคเตเดคเดกเต `method_name` เดชเดพเดฐเดพเดฎเตเดฑเตเดฑเดฑเดฟเตฝ เดเดฃเตเดเดพเดเตเด. เด เดซเดเดเตเดทเตป เดตเดฟเดณเดฟเดเตเด เดฎเตเดคเตเดคเดกเต เดธเตเดฐเดฟเดฏเตฝ เดชเตเตผเดเตเดเดฟเตฝ เดชเตเดฐเดฟเดจเตเดฑเต เดเตเดฏเตเดฏเตเด, เดคเตเดเตผเดจเตเดจเต เดฎเตเดคเตเดคเดกเต เดเดจเตเดธเดฐเดฟเดเตเดเต เดฑเตเดฒเต เดเดฃเต เดเดซเต เดเดเตเดเตเด.

    > ๐ เดเดคเต เดเดฐเต เดกเดฏเดฐเดเตเดฑเตเดฑเต เดฎเตเดคเตเดคเดกเต เดฑเดฟเดเตเดตเดธเตเดฑเตเดฑเต เดตเดดเดฟ เดจเดเดชเตเดชเดฟเดฒเดพเดเตเดเดพเด, เดฑเตเดฒเตเดฏเตเดเต เดเดเตเดฐเดนเดฟเดเตเดเตเดจเตเดจ เดจเดฟเดฒ เดฎเตเดคเตเดคเดกเต เดเดญเตเดฏเตผเดคเตเดฅเดจเดฏเตเดเตเดชเตเดชเด เดชเดพเดฐเดพเดฎเตเดฑเตเดฑเดฑเดพเดฏเดฟ เดชเดพเดธเตเดธเต เดเตเดฏเตเดฏเตเด, เดเดคเต `payload`-เตฝ เดจเดฟเดจเตเดจเตเด เดฒเดญเดฟเดเตเดเตเด.

1. `directMethodCallback` เดซเดเดเตเดทเดจเตเดฑเต เดเดตเดธเดพเดจเด เดคเดพเดดเตเดเตเดเตเดเตเดคเตเดค เดเตเดกเต เดเตเตผเดเตเดเตเด:

    ```cpp
    char resultBuff[16];
    sprintf(resultBuff, "{\"Result\":\"\"}");
    *response_size = strlen(resultBuff);
    *response = (unsigned char *)malloc(*response_size);
    memcpy(*response, resultBuff, *response_size);

    return IOTHUB_CLIENT_OK;
    ```

    เดกเดฏเดฐเดเตเดฑเตเดฑเต เดฎเตเดคเตเดคเดกเต เดเดญเตเดฏเตผเดคเตเดฅเดจเดเตพเดเตเดเต เดฑเดธเตเดชเตเตบเดธเต เดเดตเดถเตเดฏเดฎเดพเดฃเต, เดเดคเต เดฐเดฃเตเดเต เดญเดพเดเดเตเดเตพ - เดเตเดเตเดธเตเดฑเตเดฑเต เดฑเดธเตเดชเตเตบเดธเต, เดฑเดฟเดเตเดเตเตบ เดเตเดกเต. เด เดเตเดกเต เดเตเดตเดเต เดเตเดเตเดคเตเดค JSON เดซเตเตผเดฎเดพเดฑเตเดฑเดฟเตฝ เดซเดฒเด เดเดฃเตเดเดพเดเตเดเตเด:

    ```JSON
    {
        "Result": ""
    }
    ```

    เดเดคเต `response` เดชเดพเดฐเดพเดฎเตเดฑเตเดฑเดฑเดฟเดฒเตเดเตเดเต เดเตเดชเตเดชเดฟ เดเตเดฏเตเดฏเตเด, `response_size`-เตฝ เดตเดฒเดฟเดชเตเดชเด เดจเตฝเดเตเด. เดชเดฟเดจเตเดจเตเดเต `IOTHUB_CLIENT_OK` เดฑเดฟเดเตเดเตเตบ เดเตเดฏเตเดฏเตเดจเตเดจเต, เดฎเตเดคเตเดคเดกเต เดถเดฐเดฟเดฏเดพเดฏเดฟ เดเตเดเดพเดฐเตเดฏเด เดเตเดฏเตเดคเดคเดพเดฏเดฟ เดธเตเดเดฟเดชเตเดชเดฟเดเตเดเดพเตป.

1. เดเตเตพเดฌเดพเดเตเดเต เดฌเดจเตเดงเดฟเดชเตเดชเดฟเดเตเดเดพเตป `connectIoTHub` เดซเดเดเตเดทเดจเตเดฑเต เดเดตเดธเดพเดจเด เดคเดพเดดเต เดเตเดเตเดคเตเดคเดคเต เดเตเตผเดเตเดเตเด:

    ```cpp
    IoTHubClient_LL_SetDeviceMethodCallback(_device_ll_handle, directMethodCallback, NULL);
    ```

1. `loop` เดซเดเดเตเดทเตป IoTHubDeviceClient_LL_DoWork เดซเดเดเตเดทเตป เดเตเตพเดเตเดฏเตเดคเต เดนเดฌเต เดเดฏเดเตเดเตเดจเตเดจ เดเดตเดจเตเดฑเตเดเตพ เดชเตเดฐเตเดธเดธเต เดเตเดฏเตเดฏเตเด. เดเดคเต เดเดฐเต 10 เดธเตเดเตเดเตปเดกเตเดเตพเดเตเดเต เดเดฐเดฟเดเตเดเตฝ `delay` เดฎเตเดฒเด เดฎเดพเดคเตเดฐเดฎเดพเดฃเต เดตเดฟเดณเดฟเดเตเดเดชเตเดชเตเดเตเด, เดเดคเดฟเดจเดพเตฝ เดกเดฏเดฐเดเตเดฑเตเดฑเต เดฎเตเดคเตเดคเดกเต เดชเตเดฐเตเดธเดธเดฟเดเต 10 เดธเตเดเตเดเตปเดกเต เดเดเดตเตเดณ เดฎเดพเดคเตเดฐเดฎเต เดเดฃเตเดเดพเดฏเดฟเดฐเดฟเดเตเดเต. เดเดคเต เดเดพเดฐเตเดฏเดเตเดทเดฎเดฎเดพเดเตเดเดพเตป 10 เดธเตเดเตเดเตปเดกเต เดกเดฟเดฒเต เดชเดฒ เดเตเดฑเดฟเดฏ เดกเดฟเดฒเตเดทเดจเดพเดฏเดฟ เดฎเดพเดฑเตเดฑเดฟ เดเดฐเต เดชเตเดฐเดพเดตเดถเตเดฏเด `IoTHubDeviceClient_LL_DoWork` เดตเดฟเดณเดฟเดเตเดเดพเด. เดเดคเดฟเดจเดพเดฏเดฟ `loop`-เดเตเดเต เดฎเตเตปเดชเต เดคเดพเดดเตเดเตเดเตเดเตเดคเตเดค เดเตเดกเต เดเตเตผเดเตเดเตเด:

    ```cpp
    void work_delay(int delay_time)
    {
        int current = 0;
        do
        {
            IoTHubDeviceClient_LL_DoWork(_device_ll_handle);
            delay(100);
            current += 100;
        } while (current < delay_time);
    }
    ```

    เด เดเตเดกเต เดเดตเตผเดคเตเดคเดฟเดเตเดเต เดชเตเดฐเดตเตผเดคเตเดคเดฟเดเตเดเตเดเดฏเดพเดฃเต, เดเดฐเต เดคเดตเดฃเดฏเตเด `IoTHubDeviceClient_LL_DoWork` เดตเดฟเดณเดฟเดเตเดเต 100ms เดกเดฟเดฒเต เดเตเดฏเตเดฏเตเดจเตเดจเต. เดเดคเต `delay_time` เดชเดพเดฐเดพเดฎเตเดฑเตเดฑเดฑเดฟเตฝ เดจเตฝเดเดฟเดฏ เดธเดฎเดฏเดคเตเดคเตเดเตเดเต เดเดตเดถเตเดฏเดคเตเดคเดฟเดจเต เดเดตเดฐเตเด. เดเดคเดพเดฏเดคเต, เดเดชเดเดฐเดฃเด เดเตเดเตเดคเตฝ 100ms เดเดฃเตเดเดพเดเดพเดคเต เดกเดฏเดฐเดเตเดฑเตเดฑเต เดฎเตเดคเตเดคเดกเต เดเดญเตเดฏเตผเดคเตเดฅเดจเดเตพ เดชเตเดฐเดพเดธเดธเตเดธเต เดเตเดฏเตเดฏเดพเตป เดธเดพเดงเดฟเดเตเดเตเด.

1. `loop` เดซเดเดเตเดทเดจเดฟเตฝ `IoTHubDeviceClient_LL_DoWork` เดเตเตพ เดจเตเดเตเดเด เดเตเดฏเตเดคเต `delay(10000)` เดคเดพเดดเตเดเตเดเตเดเตเดคเตเดค เดเตเดกเดฟเตฝ เดฎเดพเดฑเตเดฑเตเด:

    ```cpp
    work_delay(10000);
    ```

> ๐ เด เดเตเดกเต [code/wio-terminal](../../../../../2-farm/lessons/4-migrate-your-plant-to-the-cloud/code/wio-terminal) เดซเตเดณเดกเดฑเดฟเตฝ เดฒเดญเตเดฏเดฎเดพเดฃเต.

๐ เดจเดฟเดเตเดเดณเตเดเต เดฎเดฃเตเดฃเต เดคเตเดฐเตเดฏเดค เดธเตเตปเดธเตผ เดชเตเดฐเตเดเตเดฐเดพเด เดจเดฟเดเตเดเดณเตเดเต IoT Hub-เดฒเดฟเดจเตเดเต เดเดฃเดเตเดฑเตเดฑเต เดเตเดฏเตเดคเต!

---

<!-- CO-OP TRANSLATOR DISCLAIMER START -->
**เดเดธเตเดฏเดชเตเดชเตเดเตเดคเตเดคเตฝ**:
เด เดฐเตเด AI เดตเดฟเดตเตผเดคเตเดคเดจ เดธเตเดตเดจเด [Co-op Translator](https://github.com/Azure/co-op-translator) เดเดชเดฏเตเดเดฟเดเตเดเต เดตเดฟเดตเตผเดคเตเดคเดจเด เดเตเดฏเตเดคเดคเดพเดฃเต. เดจเดพเด เดธเดคเดฟเดจเดฟเดถเตเดเดฟเดคเดคเตเดตเด เดเดฑเดชเตเดชเดพเดเตเดเดพเดจเตเดณเตเดณ เดถเตเดฐเดฎเด เดจเดเดคเตเดคเตเดจเตเดจเตเดเตเดเดฟเดฒเตเด, เดเดเตเดเตเดฎเดพเดฑเตเดฑเดฟเดเต เดตเดฟเดตเตผเดคเตเดคเดจเดเตเดเดณเดฟเตฝ เดชเดฟเดถเดเตเดเดณเต เดเดเตเดทเดฎเดคเดเดณเต เดเดฃเตเดเดพเดเดพเด เดเดจเตเดจเดคเดฟเดจเต เดฆเดฏเดตเดพเดฏเดฟ เดถเตเดฐเดฆเตเดงเดฟเดเตเดเตเด. เดฎเดพเดคเตเดญเดพเดทเดฏเดฟเดฒเต เดฏเดฅเดพเตผเดคเตเดฅ เดฐเตเด authoritative เดเดฑเดตเดฟเดเดฎเดพเดฏเดฟเดฐเดฟเดเตเดเดฃเด. เดจเดฟเตผเดฃเตเดฃเดพเดฏเด เดตเดฟเดตเดฐเดเตเดเตพเดเตเดเต, เดชเตเดฐเตเดซเดทเดฃเตฝ เดฎเดจเตเดทเตเดฏ เดตเดฟเดตเตผเดคเตเดคเดจเด เดถเตเดชเดพเตผเดถ เดเตเดฏเตเดคเดคเดพเดฃเต. เด เดตเดฟเดตเตผเดคเตเดคเดจเด เดเดชเดฏเตเดเดฟเดเตเดเตเดจเดฟเดฒเดตเดฟเดฒเต เดคเตเดฑเตเดฑเตเดเตพ เดเดฒเตเดฒเตเดเตเดเดฟเตฝ เดคเตเดฑเตเดฑเดฟเดฆเตเดงเดพเดฐเดฃเดเตพเดเตเด ์ฐ๋ฆฌ๋ เดเดคเตเดคเดฐเดตเดพเดฆเดฟเดเตพ เดเดฒเตเดฒ.
<!-- CO-OP TRANSLATOR DISCLAIMER END -->